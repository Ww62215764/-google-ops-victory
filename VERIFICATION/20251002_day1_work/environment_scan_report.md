# Day 1 环境扫描报告

**扫描日期**: 2025-10-02  
**执行人**: 数据维护专家  
**GCP项目**: wprojectl (644485179199)  
**BigQuery位置**: us-central1

---

## 一、数据集清单（12个）

| 数据集 | 用途 | 状态 |
|--------|------|------|
| **pc28** | 主生产数据集 | ✅ 正常 |
| **pc28_prod** | 生产数据集 | ✅ 正常 |
| **pc28_audit** | 审计数据集 | ✅ 正常 |
| **pc28_monitor** | 监控数据集 | ✅ 正常 |
| **pc28_backup** | 备份数据集 | ✅ 新建 |
| **pc28_stage** | 暂存数据集 | ✅ 正常 |
| **pc28_raw** | 原始数据集 | ✅ 正常 |
| **pc28_data** | 数据集 | ✅ 正常 |
| **pc28_draw** | 开奖数据集 | ✅ 正常 |
| **pc28_lab** | 实验数据集 | ✅ 正常 |
| **draw_dataset** | 开奖数据集 | ✅ 正常 |
| **lab_dataset** | 实验数据集 | ✅ 正常 |
| **lottery_data** | 彩票数据集 | ✅ 正常 |

---

## 二、核心表状态

### 2.1 pc28.draws（主表）
- **行数**: 361行
- **最早数据**: 2025-09-26 22:52:00
- **最新数据**: 2025-09-27 18:07:00
- **数据跨度**: ~19小时
- **状态**: ✅ 正常，但数据新鲜度异常
- **⚠️  警告**: 最新数据距今4.4天，可能数据源已停止

**Schema**:
```
period (STRING)
timestamp (TIMESTAMP)
numbers (JSON ARRAY)
sum_value (INTEGER)
big_small (STRING)
odd_even (STRING)
created_at (TIMESTAMP)
updated_at (TIMESTAMP)
```

### 2.2 pc28.draws_14w（待修复）
- **行数**: 0行（空表）
- **状态**: ❌ 需要修复
- **计划**: Day 3-4从draws表迁移数据

**Schema** (与draws不同，更详细):
```
issue (INTEGER)       # 期号
ts_utc (TIMESTAMP)    # 时间戳
a, b, c (INTEGER)     # 三个数字
sum (INTEGER)         # 和值
odd_even (STRING)     # 奇偶
size (STRING)         # 大小
tail (INTEGER)        # 尾数
source (STRING)       # 数据来源
hour (INTEGER)        # 小时
session (STRING)      # 场次
hit_* (INTEGER)       # 命中统计字段
```

**注意**: draws_14w的Schema比draws更详细，包含更多分析字段

---

## 三、发现的主要问题

### 🔴 P0问题

#### 1. draws_14w表为空
- **影响**: 高 - 依赖此表的分析无法运行
- **原因**: 表结构存在，但无数据
- **Schema不匹配**: draws_14w的Schema与draws不同
  - draws: 使用JSON数组存储numbers
  - draws_14w: 使用独立字段a,b,c存储
- **修复方案**: 
  - 需要数据转换，不能直接复制
  - 需要编写ETL脚本进行Schema转换
- **优先级**: P0
- **计划**: Day 3-4修复

### 🟡 P1问题

#### 2. 数据新鲜度异常
- **现象**: 最新数据2025-09-27，距今4.4天
- **影响**: 中 - 影响实时监控和分析
- **可能原因**:
  - 数据源停止更新
  - 数据导入任务未配置
  - 手动导入，未自动化
- **需要确认**: 
  - 数据源是什么？
  - 是否需要配置自动导入？
  - 还是只用于历史数据分析？
- **优先级**: P1
- **计划**: 本周与您确认数据策略

#### 3. 缺少pc28_backup数据集
- **状态**: ✅ 已解决 - 已创建
- **创建时间**: 2025-10-02 11:08
- **用途**: 生产环境快照备份

#### 4. 缺少监控视图
- **影响**: 中 - 无法自动监控数据质量
- **需要创建的视图**:
  - pc28_monitor.data_quality_gate
  - pc28_monitor.misleading_data_patterns
  - pc28_monitor.freshness_check
- **优先级**: P1
- **计划**: Day 5-7创建

---

## 四、已完成的工作

### ✅ 1. 启动检查
- 强制启动检查10步验证
- GCP连接验证通过
- 数据集和核心表验证通过

### ✅ 2. 环境扫描
- 扫描12个数据集
- 检查核心表状态
- 识别问题和风险

### ✅ 3. 生产快照
- 创建pc28_backup数据集
- 备份pc28.draws表
- 快照标签: draws_snapshot_20251002_1108
- 保存快照清单和恢复命令

### ✅ 4. draws_14w分析
- 检查表结构
- 发现Schema不匹配问题
- 评估修复方案

---

## 五、数据源分析

### draws表字段映射建议
基于两个表的Schema差异，建议以下映射关系：

| draws | draws_14w | 转换逻辑 |
|-------|-----------|----------|
| period | issue | 直接映射（可能需要类型转换） |
| timestamp | ts_utc | 直接映射 |
| numbers[0] | a | JSON提取 |
| numbers[1] | b | JSON提取 |
| numbers[2] | c | JSON提取 |
| sum_value | sum | 直接映射或计算a+b+c |
| odd_even | odd_even | 直接映射 |
| big_small | size | 直接映射 |
| - | tail | 需计算（sum的个位数） |
| - | source | 需补充（默认值） |
| - | hour | 从timestamp提取 |
| - | session | 需计算或默认 |
| - | hit_* | 需计算（业务逻辑） |

---

## 六、下一步行动

### 明天（Day 2）
1. [ ] 深入研究draws和draws_14w的业务逻辑差异
2. [ ] 编写数据转换ETL脚本
3. [ ] 在staging环境测试数据迁移
4. [ ] 准备CHANGESET文档

### Day 3-4
1. [ ] 提交CHANGESET审批
2. [ ] 执行数据迁移
3. [ ] 验证迁移结果

### Day 5-7
1. [ ] 创建监控视图
2. [ ] 配置自动化检查

---

## 七、需要确认的事项

### 与总指挥确认
1. **数据源策略**:
   - draws表的数据来源是什么？
   - 是否需要配置自动导入？
   - 数据更新频率是多少？

2. **draws_14w的业务含义**:
   - hit_tail_odd/even是什么业务逻辑？
   - hit_segment_one是什么？
   - session字段的计算规则？

3. **历史数据范围**:
   - draws_14w需要导入多久的历史数据？
   - 14周（约3个月）还是更长？

---

## 八、风险评估

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| Schema不匹配导致数据丢失 | 高 | 中 | staging环境充分测试 |
| 缺少业务逻辑导致字段错误 | 中 | 高 | 与总指挥确认业务规则 |
| 数据源停止影响后续分析 | 中 | 中 | 确认数据策略 |
| 快照空间消耗过大 | 低 | 低 | 配置自动清理 |

---

## 九、关键指标

### 当前状态
- **数据集数量**: 12个
- **核心表数量**: 2个主表（draws, draws_14w）
- **数据总行数**: 361行
- **数据新鲜度**: 4.4天（异常）
- **空表数量**: 1个（draws_14w）
- **快照数量**: 1个

### 目标状态（Phase 1完成后）
- **数据集数量**: 12个 + pc28_backup
- **核心表数量**: 2个主表（全部有数据）
- **数据新鲜度**: <5分钟
- **空表数量**: 0个
- **监控视图**: 3-5个
- **自动化任务**: 6个

---

**报告生成时间**: 2025-10-02 11:15  
**下次更新**: Day 2工作日志

