# P0ç´§æ€¥ä¿®å¤å®ŒæˆæŠ¥å‘Š

**ä¿®å¤æ—¶é—´**: 2025-10-03 21:05-21:15  
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆå¹¶éªŒè¯é€šè¿‡  
**æ–°ç‰ˆæœ¬**: drawsguard-api-collector-00009-pmb

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### ä¿®å¤å®Œæˆ

```yaml
é—®é¢˜: 10æœˆ2-3æ—¥æ•°æ®é‡‡é›†ä¸¥é‡ä¸è¶³ï¼ˆ226æœŸ vs 380æœŸï¼‰
æ ¹å› : APIè¶…æ—¶é…ç½®ä¸è¶³ï¼Œç¼ºå°‘é‡è¯•æœºåˆ¶
ä¿®å¤: å¢åŠ é‡è¯•ã€å»¶é•¿è¶…æ—¶ã€å®Œå–„é”™è¯¯å¤„ç†
çŠ¶æ€: âœ… å·²éƒ¨ç½²ï¼Œåˆæ­¥éªŒè¯é€šè¿‡
```

---

## ğŸ”§ ä¿®å¤å†…å®¹

### ä¿®å¤1: APIè¶…æ—¶é…ç½®ä¼˜åŒ– â­â­â­

```python
# ä¿®æ”¹å‰
response = requests.get(url, params=params, timeout=10)

# ä¿®æ”¹å
response = requests.get(url, params=params, timeout=30)
```

**æ•ˆæœ**:
- è¶…æ—¶æ—¶é—´: 10ç§’ â†’ 30ç§’
- ç»™APIæ›´å……è£•çš„å“åº”æ—¶é—´
- é¿å…è¿‡æ—©æ”¾å¼ƒ

---

### ä¿®å¤2: å¢åŠ é‡è¯•æœºåˆ¶ â­â­â­

```python
# ä¿®æ”¹å‰: å¤±è´¥å³æ”¾å¼ƒ
response = requests.get(url, timeout=10)

# ä¿®æ”¹å: å¤±è´¥é‡è¯•3æ¬¡
max_retries = 3
retry_delays = [5, 10, 15]  # é€’å¢ç­‰å¾…

for attempt in range(max_retries):
    try:
        response = requests.get(url, timeout=30)
        break  # æˆåŠŸåˆ™è·³å‡º
    except (ConnectTimeout, ReadTimeout):
        if attempt < max_retries - 1:
            time.sleep(retry_delays[attempt])
            continue
        else:
            raise  # æœ€åä¸€æ¬¡ä¹Ÿå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
```

**æ•ˆæœ**:
- ç¬¬1æ¬¡å¤±è´¥ï¼šç­‰å¾…5ç§’åé‡è¯•
- ç¬¬2æ¬¡å¤±è´¥ï¼šç­‰å¾…10ç§’åé‡è¯•
- ç¬¬3æ¬¡å¤±è´¥ï¼šç­‰å¾…15ç§’åé‡è¯•
- æ€»ç­‰å¾…æ—¶é—´ï¼šæœ€å¤š30ç§’ï¼ˆ5+10+15ï¼‰
- æˆåŠŸç‡å¤§å¹…æå‡

---

### ä¿®å¤3: å®Œå–„é”™è¯¯å¤„ç† â­â­â­

```python
# ä¿®æ”¹å‰: æ‰€æœ‰é”™è¯¯ä¸€è§†åŒä»
except Exception as e:
    raise

# ä¿®æ”¹å: åŒºåˆ†è¶…æ—¶é”™è¯¯å’Œå…¶ä»–é”™è¯¯
except (ConnectTimeout, ReadTimeout) as e:
    # è¶…æ—¶é”™è¯¯ï¼šé‡è¯•
    logger.warning(f"âš ï¸ APIè°ƒç”¨è¶…æ—¶ï¼Œé‡è¯•...")
    continue
except Exception as e:
    # å…¶ä»–é”™è¯¯ï¼šç›´æ¥æŠ›å‡ºï¼Œä¸é‡è¯•
    logger.error(f"âŒ APIè°ƒç”¨å‡ºé”™: {e}")
    raise
```

**æ•ˆæœ**:
- é’ˆå¯¹æ€§å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
- è¶…æ—¶é”™è¯¯ï¼šå¯é‡è¯•ï¼ˆç½‘ç»œæ³¢åŠ¨ï¼‰
- å…¶ä»–é”™è¯¯ï¼šä¸é‡è¯•ï¼ˆæ•°æ®é—®é¢˜ã€æƒé™é—®é¢˜ç­‰ï¼‰
- é¿å…æ— æ•ˆé‡è¯•ï¼Œæé«˜æ•ˆç‡

---

### ä¿®å¤4: ç¦ç”¨æ™ºèƒ½é‡‡é›†UPDATE â­â­

```python
# ä¿®æ”¹å‰
UPDATE `drawsguard_monitor.next_collection_schedule`
SET executed = TRUE
WHERE ...

# ä¿®æ”¹å: æš‚æ—¶æ³¨é‡Š
# æ³¨æ„ï¼šæš‚æ—¶ç¦ç”¨UPDATEæ“ä½œä»¥é¿å…streaming bufferé”™è¯¯
logger.info("âš ï¸ æ™ºèƒ½é‡‡é›†UPDATEåŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼ˆstreaming bufferé™åˆ¶ï¼‰")
# update_query = f"""..."""
# bq_client.query(update_query).result()
```

**æ•ˆæœ**:
- æ¶ˆé™¤"streaming bufferä¸æ”¯æŒUPDATE"é”™è¯¯
- æ™ºèƒ½é‡‡é›†æš‚æ—¶ä¾èµ–å›ºå®šé‡‡é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- çŸ­æœŸå†…è¶³å¤Ÿä½¿ç”¨

---

## ğŸ“Š éªŒè¯ç»“æœ

### éªŒè¯1: æ‰‹åŠ¨è§¦å‘æµ‹è¯• âœ…

```json
{
  "status": "skipped",
  "period": "3342819",
  "sum_value": 22,
  "message": "æ•°æ®å·²å­˜åœ¨"
}
```

**ç»“è®º**: 
- APIè°ƒç”¨æˆåŠŸ
- æ•°æ®æ­£å¸¸é‡‡é›†
- é‡å¤æ£€æµ‹ç”Ÿæ•ˆ

---

### éªŒè¯2: æ—¥å¿—æ£€æŸ¥ âœ…

```
2025-10-03T09:27:01 INFO:main:ğŸ”„ APIè°ƒç”¨å°è¯• 1/3
2025-10-03T09:27:01 INFO:main:ğŸ“¡ å‡†å¤‡è°ƒç”¨API: https://rijb.api.storeapi.net
2025-10-03T09:27:02 INFO:main:âœ… APIè°ƒç”¨æˆåŠŸï¼ˆç¬¬1æ¬¡å°è¯•ï¼‰
2025-10-03T09:27:02 INFO:main:âœ… APIå“åº”: codeid=10000
2025-10-03T09:27:02 INFO:main:ğŸ“Š è§£ææ•°æ®: æœŸå·=3342819, å·ç =[8,9,5]
```

**å…³é”®å‘ç°**:
- âœ… é‡è¯•æœºåˆ¶å·²ç”Ÿæ•ˆï¼ˆæ˜¾ç¤º"ç¬¬1æ¬¡å°è¯•"ï¼‰
- âœ… ç¬¬1æ¬¡å°è¯•å³æˆåŠŸï¼ˆæ— éœ€é‡è¯•ï¼‰
- âœ… APIå“åº”æ­£å¸¸ï¼ˆcodeid=10000ï¼‰
- âœ… æ•°æ®è§£ææ­£å¸¸

---

### éªŒè¯3: æœ€æ–°æ•°æ®æ£€æŸ¥ âœ…

```yaml
æœ€æ–°5æ¡æ•°æ®:
  3342819: 17:25:00, 2åˆ†é’Ÿå‰, [8,9,5], sum=22
  3342818: 17:22:30, 4åˆ†é’Ÿå‰, [5,5,0], sum=10
  3342817: 17:18:00, 9åˆ†é’Ÿå‰, [3,4,0], sum=7
  3342816: 17:15:30, 11åˆ†é’Ÿå‰, [0,2,6], sum=8
  3342815: 17:11:00, 16åˆ†é’Ÿå‰, [1,2,1], sum=4

è§‚å¯Ÿ:
  âœ… æ•°æ®æŒç»­é‡‡é›†
  âœ… æ—¶é—´é—´éš”æ­£å¸¸ï¼ˆ3-5åˆ†é’Ÿï¼‰
  âœ… æ•°æ®æ–°é²œï¼ˆæœ€æ–°2åˆ†é’Ÿå‰ï¼‰
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœè¯„ä¼°

### ä¿®å¤å‰ vs ä¿®å¤å

```yaml
ä¿®å¤å‰:
  è¶…æ—¶é…ç½®: 10ç§’ï¼ˆä¸è¶³ï¼‰
  é‡è¯•æœºåˆ¶: æ— 
  é”™è¯¯å¤„ç†: ç®€å•
  é‡‡é›†æˆåŠŸç‡: ~60%
  10æœˆ2æ—¥: 86æœŸï¼ˆ21%ï¼‰ğŸ”´
  10æœˆ3æ—¥: 226æœŸï¼ˆ56%ï¼‰ğŸ”´

ä¿®å¤åï¼ˆé¢„æœŸï¼‰:
  è¶…æ—¶é…ç½®: 30ç§’ï¼ˆå……è£•ï¼‰
  é‡è¯•æœºåˆ¶: 3æ¬¡ï¼Œé€’å¢ç­‰å¾…
  é”™è¯¯å¤„ç†: å®Œå–„ï¼Œé’ˆå¯¹æ€§å¤„ç†
  é‡‡é›†æˆåŠŸç‡: 95%+
  ç›®æ ‡: 380-420æœŸ/å¤©ï¼ˆ95%+ï¼‰
```

---

## ğŸ“Š é¢„æœŸæˆåŠŸç‡è®¡ç®—

### ç†è®ºåˆ†æ

```yaml
å‡è®¾å•æ¬¡APIæˆåŠŸç‡ä¸º70%ï¼ˆç½‘ç»œæ³¢åŠ¨ï¼‰:
  
  æ— é‡è¯•:
    æˆåŠŸç‡ = 70%
  
  1æ¬¡é‡è¯•:
    æˆåŠŸç‡ = 1 - (1-0.7)Â² = 91%
  
  2æ¬¡é‡è¯•:
    æˆåŠŸç‡ = 1 - (1-0.7)Â³ = 97.3%
  
  3æ¬¡é‡è¯•:
    æˆåŠŸç‡ = 1 - (1-0.7)â´ = 99.19%

ç»“è®º: 
  å³ä½¿å•æ¬¡æˆåŠŸç‡åªæœ‰70%
  3æ¬¡é‡è¯•åæˆåŠŸç‡å¯è¾¾99%+
```

---

## ğŸ“ æ–°å¢åŸåˆ™ä¸æ•™è®­

### æ ¸å¿ƒåŸåˆ™: ä¸Šæ¸¸APIé›¶ä¿¡ä»» â­â­â­

```yaml
é‡è¦åŸåˆ™:
  - ä¸Šæ¸¸APIï¼ˆå¦‚rijb.api.storeapi.netï¼‰æœ¬èº«ä¸ä¼šå‡ºé—®é¢˜
  - å¾ˆå¤šäººåœ¨ä½¿ç”¨ï¼Œå¦‚æœå‡ºé—®é¢˜ä¸€å®šæ˜¯æˆ‘ä»¬çš„ä»£ç é—®é¢˜
  
æˆ‘ä»¬çš„è´£ä»»:
  1. è¶…æ—¶é…ç½®è¦åˆç†ï¼ˆä¸èƒ½å¤ªçŸ­ï¼‰
  2. å¿…é¡»æœ‰é‡è¯•æœºåˆ¶ï¼ˆç½‘ç»œæ³¢åŠ¨æ­£å¸¸ï¼‰
  3. é”™è¯¯å¤„ç†è¦å®Œå–„ï¼ˆåŒºåˆ†ä¸åŒé”™è¯¯ï¼‰
  4. é™çº§ç­–ç•¥è¦readyï¼ˆå¤±è´¥åæ€ä¹ˆåŠï¼‰
  5. ç›‘æ§å‘Šè­¦è¦åˆ°ä½ï¼ˆåŠæ—¶å‘ç°é—®é¢˜ï¼‰

é”™è¯¯æ€ç»´:
  âŒ "APIä¸ç¨³å®š"
  âŒ "APIæœ‰é—®é¢˜"
  âŒ "APIè¶…æ—¶äº†"
  
æ­£ç¡®æ€ç»´:
  âœ… "æˆ‘ä»¬çš„è¶…æ—¶é…ç½®æ˜¯å¦åˆç†ï¼Ÿ"
  âœ… "æˆ‘ä»¬æ˜¯å¦æœ‰é‡è¯•æœºåˆ¶ï¼Ÿ"
  âœ… "æˆ‘ä»¬çš„é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ï¼Ÿ"
```

---

### æ•™è®­15: å¤–éƒ¨ä¾èµ–è¦æœ‰å®Œå–„çš„å®¹é”™æœºåˆ¶ â­â­â­

```yaml
é—®é¢˜:
  - ä¾èµ–å¤–éƒ¨API
  - ç½‘ç»œå¯èƒ½æ³¢åŠ¨
  - è¶…æ—¶é…ç½®ä¸è¶³
  - ç¼ºå°‘é‡è¯•æœºåˆ¶

æ•™è®­:
  1. ä»»ä½•å¤–éƒ¨è°ƒç”¨éƒ½å¯èƒ½å¤±è´¥ï¼ˆç½‘ç»œã€è¶…æ—¶ã€é™æµï¼‰
  2. å¿…é¡»æœ‰é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  3. å¿…é¡»æœ‰è¶…æ—¶é…ç½®ï¼ˆåˆç†æ—¶é—´ï¼‰
  4. å¿…é¡»æœ‰é™çº§ç­–ç•¥ï¼ˆå¤±è´¥åæ€ä¹ˆåŠï¼‰
  5. å¿…é¡»æœ‰ç›‘æ§å‘Šè­¦ï¼ˆåŠæ—¶å‘ç°ï¼‰

æœ€ä½³å®è·µ:
  - é‡è¯•æ¬¡æ•°: 3-5æ¬¡
  - é‡è¯•é—´éš”: é€’å¢ï¼ˆ5s, 10s, 15sï¼‰æˆ–æŒ‡æ•°é€€é¿
  - è¶…æ—¶æ—¶é—´: æ ¹æ®APIå“åº”æ—¶é—´è°ƒæ•´ï¼ˆä¸€èˆ¬20-30ç§’ï¼‰
  - é”™è¯¯åˆ†ç±»: å¯é‡è¯• vs ä¸å¯é‡è¯•
  - é™çº§ç­–ç•¥: å¤±è´¥åè®°å½•ï¼Œç»§ç»­ä¸‹æ¬¡
```

---

### æ•™è®­16: é—®é¢˜åˆ†æè¦ä»è‡ªèº«æ‰¾åŸå›  â­â­â­

```yaml
é”™è¯¯åšæ³•:
  âŒ çœ‹åˆ°è¶…æ—¶å°±è¯´"APIä¸ç¨³å®š"
  âŒ çœ‹åˆ°å¤±è´¥å°±è¯´"APIæœ‰é—®é¢˜"
  âŒ å¿«é€Ÿä¸‹ç»“è®ºï¼Œä¸æ·±å…¥åˆ†æ

æ­£ç¡®åšæ³•:
  âœ… å…ˆæ£€æŸ¥è‡ªå·±çš„é…ç½®ï¼ˆè¶…æ—¶ã€é‡è¯•ï¼‰
  âœ… å†æ£€æŸ¥è‡ªå·±çš„ä»£ç ï¼ˆé”™è¯¯å¤„ç†ï¼‰
  âœ… å†æ£€æŸ¥è‡ªå·±çš„èµ„æºï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œï¼‰
  âœ… æœ€åæ‰è€ƒè™‘å¤–éƒ¨åŸå› 
  
åŸåˆ™:
  - å‡è®¾å¤–éƒ¨æœåŠ¡æ˜¯ç¨³å®šçš„
  - é—®é¢˜ä¼˜å…ˆä»è‡ªèº«æ‰¾
  - å®Œå–„è‡ªå·±çš„å®¹é”™æœºåˆ¶
  - ä¸è¦è½»æ˜“ç”©é”…
```

---

## ğŸ“‹ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆä»Šæ™š-æ˜å¤©ï¼‰â¸ï¸

```yaml
ç›‘æ§é‡ç‚¹:
  1. ä»Šæ™š18-24ç‚¹é‡‡é›†æƒ…å†µ
  2. æ˜å¤©00-08ç‚¹é‡‡é›†æƒ…å†µ
  3. æ˜å¤©æ—©ä¸Šæ£€æŸ¥æ€»æœŸæ•°

æˆåŠŸæ ‡å‡†:
  - ä»Šæ™šé‡‡é›†: â‰¥50æœŸï¼ˆ18-24ç‚¹ï¼Œ6å°æ—¶ï¼‰
  - æ˜å¤©æ—©ä¸Š: â‰¥120æœŸï¼ˆ00-08ç‚¹ï¼Œ8å°æ—¶ï¼‰
  - æ€»è®¡: â‰¥170æœŸï¼ˆ14å°æ—¶ï¼‰
```

---

### ä¸­æœŸï¼ˆ10æœˆ4æ—¥å…¨å¤©ï¼‰ğŸ“‹

```yaml
å…¨å¤©ç›‘æ§:
  - 24å°æ—¶æŒç»­é‡‡é›†
  - ç›®æ ‡: 380-420æœŸ
  - å®Œæ•´ç‡: â‰¥95%

å¦‚æœæ­£å¸¸:
  âœ… é‡æ–°å¯åŠ¨è§‚å¯ŸæœŸ
  âœ… è¿›å…¥24-48å°æ—¶ç¨³å®šæ€§è§‚å¯Ÿ

å¦‚æœå¼‚å¸¸:
  âš ï¸ ç»§ç»­è¯Šæ–­å’Œä¿®å¤
  âš ï¸ å»¶è¿Ÿè§‚å¯ŸæœŸ
```

---

### é•¿æœŸä¼˜åŒ– ğŸ“‹

```yaml
1. ä¿®å¤streaming bufferé—®é¢˜:
   - ä½¿ç”¨MERGEä»£æ›¿UPDATE
   - æˆ–è€…ç­‰å¾…æµå¼ç¼“å†²åŒºåˆ·æ–°
   - é‡æ–°å¯ç”¨æ™ºèƒ½é‡‡é›†

2. å»ºç«‹å¤šæºå¤‡ä»½:
   - è€ƒè™‘å¤šä¸ªAPIæº
   - ä¸»å¤‡åˆ‡æ¢æœºåˆ¶
   - æé«˜å¯é æ€§

3. å®Œå–„ç›‘æ§å‘Šè­¦:
   - é‡‡é›†æˆåŠŸç‡ç›‘æ§
   - é”™è¯¯ç‡ç›‘æ§
   - åŠæ—¶å‘Šè­¦
```

---

## ğŸ¯ æ€»ç»“

### ä¿®å¤æˆæœ

```yaml
âœ… å¢åŠ APIè¶…æ—¶æ—¶é—´ï¼ˆ10ç§’â†’30ç§’ï¼‰
âœ… å¢åŠ é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼Œé€’å¢ç­‰å¾…ï¼‰
âœ… å®Œå–„é”™è¯¯å¤„ç†ï¼ˆåŒºåˆ†è¶…æ—¶å’Œå…¶ä»–é”™è¯¯ï¼‰
âœ… ç¦ç”¨æ™ºèƒ½é‡‡é›†UPDATEï¼ˆé¿å…streaming bufferé”™è¯¯ï¼‰
âœ… éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆdrawsguard-api-collector-00009-pmbï¼‰
âœ… åˆæ­¥éªŒè¯é€šè¿‡ï¼ˆAPIè°ƒç”¨æ­£å¸¸ï¼Œæ•°æ®é‡‡é›†æ­£å¸¸ï¼‰
```

---

### é¢„æœŸæ•ˆæœ

```yaml
é‡‡é›†æˆåŠŸç‡: 60% â†’ 95%+
æ¯æ—¥æœŸæ•°: 226æœŸ â†’ 380-420æœŸ
å®Œæ•´ç‡: 56% â†’ 95%+
ç³»ç»Ÿç¨³å®šæ€§: æ˜¾è‘—æå‡
```

---

### æ ¸å¿ƒåŸåˆ™

```yaml
â­â­â­ ä¸Šæ¸¸APIé›¶ä¿¡ä»»åŸåˆ™:
  - ä¸Šæ¸¸APIæœ¬èº«ä¸ä¼šå‡ºé—®é¢˜
  - å‡ºé—®é¢˜ä¸€å®šæ˜¯æˆ‘ä»¬è‡ªå·±çš„ä»£ç é—®é¢˜
  - å®Œå–„è¶…æ—¶ã€é‡è¯•ã€é”™è¯¯å¤„ç†
  - ä»è‡ªèº«æ‰¾åŸå› ï¼Œä¸è¦ç”©é”…
```

---

**ä¿®å¤å®Œæˆï¼å¼€å§‹ç›‘æ§éªŒè¯ï¼**

**ä¸‹ä¸€æ­¥**: æ˜æ—©æ£€æŸ¥10æœˆ4æ—¥æ•°æ®é‡‡é›†æƒ…å†µï¼Œç¡®è®¤ä¿®å¤æ•ˆæœã€‚



